# Build the Codex CLI Lambda Layer.
#
# Assembles a ZIP containing:
#   - Codex CLI binary (from tyrchen/codex fork)
#   - CLI tools (rg, jq, etc.) from GitHub Releases
#   - System tools (tree, git) from Amazon Linux 2023
#
# Assets are declared in assets.yaml at the repo root.
# To add a new tool, edit assets.yaml and push — no workflow changes needed.
#
# Releases are versioned by the codex binary version (e.g. v0.107.0-alpha.8).
# A rolling 'latest' release always points to the newest build.
# Other repos can download it via:
#   gh release download latest --repo tyrchen/codex-layer --pattern 'codex-layer.zip'

name: build-layer

on:
  workflow_dispatch:
  push:
    branches: [master]
    paths: [assets.yaml]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write

env:
  LAYER_DIR: /tmp/codex-layer
  LAYER_ZIP: /tmp/codex-layer.zip

jobs:
  build:
    name: Build Lambda Layer (aarch64)
    runs-on: ubuntu-24.04-arm
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v4

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq \
            https://github.com/mikefarah/yq/releases/latest/download/yq_linux_arm64
          sudo chmod +x /usr/local/bin/yq

      - name: Build layer
        env:
          GH_TOKEN: ${{ github.token }}
          LAYER_DIR: ${{ env.LAYER_DIR }}
          LAYER_ZIP: ${{ env.LAYER_ZIP }}
        run: scripts/build-layer.sh

      - name: Determine version
        id: version
        run: |
          CODEX_VERSION=$(cat "$LAYER_DIR/codex-version.txt")
          echo "codex_version=$CODEX_VERSION" >> "$GITHUB_OUTPUT"
          echo "tag=v${CODEX_VERSION}" >> "$GITHUB_OUTPUT"
          echo "==> Release version: v${CODEX_VERSION}"

      - name: Create versioned release
        env:
          GH_TOKEN: ${{ github.token }}
          TAG: ${{ steps.version.outputs.tag }}
          CODEX_VERSION: ${{ steps.version.outputs.codex_version }}
        run: |
          # Skip if this version was already released
          if gh release view "$TAG" &>/dev/null; then
            echo "==> Release $TAG already exists, updating..."
            gh release delete "$TAG" --yes
            git push origin ":refs/tags/$TAG" 2>/dev/null || true
          fi

          git tag -f "$TAG"
          git push origin "$TAG" --force

          gh release create "$TAG" \
            --title "Codex CLI Lambda Layer $TAG" \
            --notes "## Codex CLI Lambda Layer

          **Codex version:** \`$CODEX_VERSION\`
          **Built from:** [\`${{ github.sha }}\`](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
          **Date:** $(date -u +%Y-%m-%d)

          ### Contents
          See [assets.yaml](https://github.com/${{ github.repository }}/blob/master/assets.yaml) for the full manifest.

          ### Usage
          \`\`\`bash
          # Download latest
          gh release download latest --repo ${{ github.repository }} -p 'codex-layer.zip'

          # Download specific version
          gh release download $TAG --repo ${{ github.repository }} -p 'codex-layer.zip'
          \`\`\`" \
            "${{ env.LAYER_ZIP }}#codex-layer.zip"

      - name: Update latest release
        env:
          GH_TOKEN: ${{ github.token }}
          TAG: ${{ steps.version.outputs.tag }}
          CODEX_VERSION: ${{ steps.version.outputs.codex_version }}
        run: |
          gh release delete latest --yes 2>/dev/null || true
          git push origin :refs/tags/latest 2>/dev/null || true

          git tag -f latest
          git push origin latest --force

          gh release create latest \
            --title "Latest Codex CLI Lambda Layer ($TAG)" \
            --notes "Rolling release — always points to the newest build.

          **Current version:** \`$CODEX_VERSION\` ([$TAG](https://github.com/${{ github.repository }}/releases/tag/$TAG))

          \`\`\`bash
          gh release download latest --repo ${{ github.repository }} -p 'codex-layer.zip'
          \`\`\`" \
            --latest \
            "${{ env.LAYER_ZIP }}#codex-layer.zip"
