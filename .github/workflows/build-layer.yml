# Build the Codex CLI Lambda Layer.
#
# Assembles a ZIP containing:
#   - Codex CLI binary (from tyrchen/codex fork)
#   - CLI tools (rg, jq, etc.) from GitHub Releases
#   - System tools (tree, git) from Amazon Linux 2023
#
# Assets are declared in assets.yaml at the repo root.
# To add a new tool, edit assets.yaml and push â€” no workflow changes needed.
#
# The layer ZIP is published as a GitHub Release asset (tag: latest).
# Other repos can download it via:
#   gh release download latest --repo tyrchen/codex-layer --pattern 'codex-layer.zip'

name: build-layer

on:
  workflow_dispatch:
  push:
    branches: [master]
    paths: [assets.yaml]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write

env:
  LAYER_DIR: /tmp/codex-layer
  LAYER_ZIP: /tmp/codex-layer.zip

jobs:
  build:
    name: Build Lambda Layer (aarch64)
    runs-on: ubuntu-24.04-arm
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v4

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq \
            https://github.com/mikefarah/yq/releases/latest/download/yq_linux_arm64
          sudo chmod +x /usr/local/bin/yq

      - name: Build layer
        env:
          GH_TOKEN: ${{ github.token }}
          LAYER_DIR: ${{ env.LAYER_DIR }}
          LAYER_ZIP: ${{ env.LAYER_ZIP }}
        run: scripts/build-layer.sh

      - name: Generate release tag
        id: tag
        run: echo "tag=build-$(date -u +%Y%m%d-%H%M%S)" >> "$GITHUB_OUTPUT"

      - name: Create release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TAG="${{ steps.tag.outputs.tag }}"
          # Delete existing 'latest' release if present
          gh release delete latest --yes 2>/dev/null || true
          git tag -f latest
          git push origin latest --force

          gh release create latest \
            --title "Latest Codex CLI Lambda Layer" \
            --notes "Built from \`${{ github.sha }}\` on $(date -u +%Y-%m-%d).

          ## Contents
          See [assets.yaml](https://github.com/${{ github.repository }}/blob/master/assets.yaml) for the full list.

          ## Usage
          \`\`\`bash
          gh release download latest --repo ${{ github.repository }} --pattern 'codex-layer.zip'
          \`\`\`" \
            --latest \
            "${{ env.LAYER_ZIP }}#codex-layer.zip"

          # Also create a timestamped release for history
          gh release create "$TAG" \
            --title "Codex CLI Lambda Layer ($TAG)" \
            --notes "Built from \`${{ github.sha }}\`." \
            "${{ env.LAYER_ZIP }}#codex-layer.zip"
